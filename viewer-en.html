<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PLL5SLNM');</script>
    <!-- End Google Tag Manager -->
    <title>View Card</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Poppins:wght@400;700&family=Tajawal:wght@400;700&family=Lalezar&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="stylesheet" href="viewer.css">
    <script src="lang-switcher.js" defer></script>

    <meta name="color-scheme" content="light dark">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9147440531390790"
        crossorigin="anonymous"></script>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PLL5SLNM" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <nav class="viewer-nav">
        <a href="index-en.html" class="nav-logo" title="Back to Home">
            <img src="https://www.mcprim.com/nfc/mcprime-logo-transparent.png" alt="MC PRIME Logo"
                style="height: 32px; width: auto;">
        </a>
        <div class="nav-links">
            <a href="index-en.html">Home</a>
            <a href="gallery-en.html">Gallery</a>
            <a href="blog-en.html">Blog</a>
            <a href="dashboard-en.html">Dashboard</a>
            <a href="editor-en.html">Create Card</a>
        </div>

        <div class="nav-actions">
            <button id="lang-toggle-btn" class="btn" onclick="switchLanguage('ar')"
                style="padding: 6px 12px; font-size: 0.85rem; margin-right: 10px;"
                title="التبديل إلى العربية">عربي</button>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" />
                    <span class="slider round">
                        <i class="fas fa-sun sun-icon"></i>
                        <i class="fas fa-moon moon-icon"></i>
                    </span>
                </label>
            </div>
            <a href="editor-en.html" class="btn nav-cta">Create Your Card Free</a>
        </div>
    </nav>

    <div id="loader" class="viewer-loader">
        <div class="spinner"></div>
        <p>Loading card...</p>
    </div>

    <div class="viewer-container" style="display: none;">

        <div class="viewer-layout">

            <aside class="side-column active" id="left-column">

                <div class="profile-header" id="profile-header"
                    style="text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; display: none;">
                    <h1 id="profile-name" style="font-size: 1.5rem; margin: 0; color: var(--text-primary);"></h1>
                    <p id="profile-tagline" style="font-size: 1rem; color: var(--text-secondary); margin: 5px 0 0 0;">
                    </p>
                </div>

                <h2><i class="fas fa-address-book"></i> Contact Information</h2>
                <div id="contact-links-container">
                </div>
            </aside>

            <main class="center-column">
                <div class="cards-wrapper-viewer" id="cards-wrapper-viewer" title="Click to flip the card">
                    <div class="business-card-viewer" id="card-front-display">
                    </div>
                    <div class="business-card-viewer" id="card-back-display" style="transform: rotateY(180deg);">
                    </div>
                </div>
                <button id="viewer-flip-btn" class="btn" aria-label="Flip card"
                    style="display:none; position:relative; margin-top: 15px;">
                    <i class="fas fa-sync-alt"></i> <span>Flip Card</span>
                </button>
            </main>

            <aside class="side-column save-options" id="right-column">
                <h2><i class="fas fa-download"></i> Save & Share</h2>

                <button id="save-vcf-btn" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Save Contact (VCF)
                </button>
                <p
                    style="font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: 5px; margin-bottom: 15px;">
                    (File to add contact directly to your phone)
                </p>

                <!-- *** New Button: Email Signature *** -->
                <button id="save-email-sig-btn" class="btn btn-secondary" style="margin-bottom: 15px;">
                    <i class="fas fa-signature"></i>
                    Copy Email Signature
                </button>

                <details class="fieldset-accordion">
                    <summary class="secondary-actions-summary">
                        <i class="fas fa-cog"></i> More Options (PNG, PDF)
                    </summary>
                    <div class="fieldset-content secondary-actions-content">
                        <button id="save-front-png-btn" class="btn btn-secondary">
                            <i class="fas fa-image"></i>
                            Save Front (PNG)
                        </button>
                        <button id="save-back-png-btn" class="btn btn-secondary">
                            <i class="fas fa-image"></i>
                            Save Back (PNG)
                        </button>
                        <button id="save-pdf-btn" class="btn btn-secondary">
                            <i class="fas fa-file-pdf"></i>
                            Save as PDF
                        </button>
                    </div>
                </details>

                <!-- Save other person's card -->
                <div id="save-card-section" style="display: none; margin-top: 15px;">
                    <hr style="border-color: rgba(255,255,255,0.1); margin-bottom: 15px;">
                    <button id="save-card-btn" class="btn btn-secondary"
                        style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        <i class="fas fa-heart"></i>
                        <span id="save-card-text">Save This Card</span>
                    </button>
                    <p id="save-card-status"
                        style="font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: 5px; display: none;">
                    </p>
                </div>

                <div class="info-box">
                    <h3 class="info-box-title">
                        <i class="fas fa-info-circle"></i>
                        Visitor Guide
                    </h3>
                    <p class="info-box-text">
                        <strong>To Save:</strong> Click <strong>"Save Contact"</strong> to add to your phone.
                    </p>
                    <p class="info-box-text">
                        <strong>For Signature:</strong> Copy the email signature and paste it in Outlook or Gmail.
                    </p>

                    <h4 class="info-box-subtitle">
                        <i class="fas fa-lightbulb"></i> Digital Card Features
                    </h4>
                    <ul class="info-box-list">
                        <li><i class="fas fa-check-circle c-green"></i> Save contact directly</li>
                        <li><i class="fas fa-leaf c-green"></i> Reduce paper consumption</li>
                        <li><i class="fas fa-edit c-blue"></i> Edit anytime</li>
                        <li><i class="fas fa-chart-line c-yellow"></i> Track your card visits</li>
                    </ul>
                </div>

                <a href="editor-en.html" class="btn btn-secondary"
                    style="margin-top: 25px; text-align: center; width: 100%;">
                    <i class="fas fa-magic"></i> Create Your Free Card
                </a>
            </aside>

            <nav class="mobile-viewer-tabs">
                <button class="mobile-tab-btn active" data-tab-target="#left-column">
                    <i class="fas fa-address-book"></i> Contact Info
                </button>
                <button class="mobile-tab-btn" data-tab-target="#right-column">
                    <i class="fas fa-download"></i> Save & Share
                </button>
            </nav>

        </div>
    </div>

    <div class="visually-hidden">
        <div class="business-card-render-wrapper" id="front-card">
        </div>
        <div class="business-card-render-wrapper" id="back-card">
        </div>
    </div>

    <script>
        window.cardData = {};
    </script>

    <script src="/nfc/auth.js"></script>
    <script src="viewer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const designId = params.get('id');
            if (!designId) return;

            const section = document.getElementById('save-card-section');
            const btn = document.getElementById('save-card-btn');
            const btnText = document.getElementById('save-card-text');
            const statusP = document.getElementById('save-card-status');
            const baseUrl = Auth.getBaseUrl();

            try {
                const ownerRes = await fetch(`${baseUrl}/api/design-owner/${designId}`);
                const ownerData = await ownerRes.json();
                if (!ownerData.success) return;

                const isLoggedIn = Auth.isLoggedIn();
                const currentUserId = Auth.user?.userId;

                if (isLoggedIn && ownerData.ownerId === currentUserId) return;
                if (ownerData.cardPrivacy === 'deny_all') return;

                section.style.display = 'block';

                if (!isLoggedIn) {
                    btnText.textContent = 'Sign in to save this card';
                    btn.querySelector('i').className = 'fas fa-sign-in-alt';
                    btn.onclick = () => { window.location.href = '/nfc/login-en.html'; };
                    return;
                }

                // 1. Assign Click Handler IMMEDIATELY
                btn.onclick = async () => {
                    const originalText = btnText.textContent;
                    const originalIconClass = btn.querySelector('i').className;

                    btn.disabled = true;
                    btnText.textContent = 'Saving...';
                    btn.querySelector('i').className = 'fas fa-spinner fa-spin';

                    try {
                        const res = await fetch(`${baseUrl}/api/save-card/${designId}`, {
                            method: 'POST',
                            headers: { ...Auth.getHeader(), 'Content-Type': 'application/json' }
                        });

                        if (res.status === 401 || res.status === 403) {
                            Auth.logout();
                            return;
                        }

                        const data = await res.json();

                        if (data.status === 'saved' || data.status === 'already_saved') {
                            btnText.textContent = 'Saved \u2713';
                            btn.querySelector('i').className = 'fas fa-check-circle';
                            btn.style.background = '#2ecc71';
                        } else if (data.status === 'requested' || data.status === 'already_requested') {
                            btnText.textContent = 'Request Sent \u23f3';
                            btn.querySelector('i').className = 'fas fa-clock';
                            btn.style.background = '#f39c12';
                            statusP.textContent = 'The card will be added after the owner approves';
                            statusP.style.display = 'block';
                        } else if (data.status === 'denied') {
                            btnText.textContent = 'Save Not Available';
                            btn.querySelector('i').className = 'fas fa-ban';
                            btn.style.background = '#e74c3c';
                        } else {
                            throw new Error(data.error || 'Save failed');
                        }
                    } catch (err) {
                        console.error('Save card error:', err);
                        btnText.textContent = 'Error, try again';
                        btn.querySelector('i').className = 'fas fa-exclamation-triangle';
                        btn.disabled = false;

                        setTimeout(() => {
                            btnText.textContent = originalText;
                            btn.querySelector('i').className = originalIconClass;
                        }, 2000);
                    }
                };

                // 2. Then check if already saved (Non-blocking)
                try {
                    const checkRes = await fetch(`${baseUrl}/api/saved-cards`, { headers: Auth.getHeader() });
                    if (checkRes.ok) {
                        const checkData = await checkRes.json();
                        if (checkData.savedCards?.some(c => c.designShortId === designId)) {
                            btnText.textContent = 'Already Saved \u2713';
                            btn.querySelector('i').className = 'fas fa-check-circle';
                            btn.style.background = '#2ecc71';
                            btn.disabled = true;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to check saved status:', e);
                }
            } catch (err) {
                console.error('Save card init error:', err);
            }
        });
    </script>

</body>

</html>